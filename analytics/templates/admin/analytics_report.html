{% load static %}
<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - Mahmood Pharmacy Analytics</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        teal: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style> body { font-family: 'Inter', sans-serif; } </style>
    <script>
        // Immediately check theme prevents flash
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-gray-50 text-slate-800 transition-colors duration-300 dark:bg-slate-900 dark:text-slate-100">

    <!-- Navbar -->
    <nav class="sticky top-0 z-50 bg-white border-b border-gray-200 shadow-sm transition-colors duration-300 dark:bg-slate-800 dark:border-slate-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-3">
                    <a href="{% url 'admin-charts' %}" class="flex items-center gap-2 text-xl font-bold text-teal-600 dark:text-teal-400">
                        <i class="fa-solid fa-prescription-bottle-medical text-2xl"></i>
                        <span>Mahmood Pharmacy</span>
                    </a>
                </div>
                <!-- Links and Actions -->
                <div class="flex items-center gap-6">
                    <a href="{% url 'admin-charts' %}" class="text-sm font-medium text-slate-600 hover:text-teal-600 transition-colors dark:text-slate-400 dark:hover:text-teal-400">
                        <i class="fa-solid fa-arrow-left mr-1"></i> Back to Dashboard
                    </a>
                    
                    <!-- Dark Mode Toggle -->
                    <button id="theme-toggle" class="p-2 rounded-full text-slate-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-teal-500 dark:text-slate-400 dark:hover:bg-slate-700" title="Toggle Dark Mode">
                        <i id="theme-toggle-dark-icon" class="hidden fa-solid fa-moon text-lg"></i>
                        <i id="theme-toggle-light-icon" class="hidden fa-solid fa-sun text-lg"></i>
                    </button>
                    
                    <div class="hidden sm:flex items-center gap-3 border-l border-gray-300 pl-6 dark:border-slate-600">
                        <div class="text-right">
                            <p class="text-xs font-semibold text-slate-900 dark:text-white">Admin User</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">Logged in</p>
                        </div>
                        <div class="h-8 w-8 rounded-full bg-teal-100 flex items-center justify-center text-teal-700 font-bold dark:bg-teal-900 dark:text-teal-300">A</div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        
        <!-- Header & Filter -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-900 dark:text-white">{{ title }}</h1>
                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">Detailed performance report</p>
            </div>

            <div class="flex items-center bg-white dark:bg-slate-800 p-2 rounded-lg shadow-sm border border-gray-200 dark:border-slate-700">
                <label for="branchFilter" class="mr-3 ml-2 text-sm font-semibold text-slate-600 dark:text-slate-300">
                    <i class="fa-solid fa-filter mr-1"></i> Filter:
                </label>
                <select id="branchFilter" onchange="applyFilter()" class="bg-gray-50 border border-gray-300 text-slate-900 text-sm rounded-md focus:ring-teal-500 focus:border-teal-500 block w-full p-2 dark:bg-slate-700 dark:border-slate-600 dark:placeholder-slate-400 dark:text-white dark:focus:ring-teal-500 dark:focus:border-teal-500 appearance-none pr-8">
                    <option value="all" {% if selected_branch == 'all' %}selected{% endif %}>All Branches</option>
                    {% for branch in branches %}
                        <option value="{{ branch.id }}" {% if selected_branch == branch.id %}selected{% endif %}>{{ branch.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Chart Container -->
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-md border border-gray-100 dark:border-slate-700 p-6">
            <div class="flex justify-end mb-4">
                 <button onclick="downloadChart()" class="flex items-center gap-2 bg-teal-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-teal-700 transition-colors focus:ring-4 focus:ring-teal-300 dark:focus:ring-teal-900">
                    <i class="fa-solid fa-download"></i> Download PNG
                 </button>
            </div>
            
            <div class="relative w-full" style="{% if chart_type == 'pie' or chart_type == 'doughnut' %}height: 300px; display: flex; justify-content: center;{% else %}height: 300px;{% endif %}">
                <canvas id="reportChart"></canvas>
            </div>
        </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // --- Dark Mode Logic ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        function setChartTheme(isDark) {
            const color = isDark ? '#94a3b8' : '#64748b'; // slate-400 : slate-500
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            
            Chart.defaults.color = color;
            Chart.defaults.scale.grid.color = gridColor;
            
            // Re-render chart if it exists
            const chartInstance = Chart.getChart("reportChart");
            if (chartInstance) {
                chartInstance.update();
            }
        }

        // Check state set in head
        if (document.documentElement.classList.contains('dark')) {
            themeToggleLightIcon.classList.remove('hidden');
            setChartTheme(true);
        } else {
            themeToggleDarkIcon.classList.remove('hidden');
            setChartTheme(false);
        }

        themeToggleBtn.addEventListener('click', function() {
            themeToggleDarkIcon.classList.toggle('hidden');
            themeToggleLightIcon.classList.toggle('hidden');

            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('color-theme', 'light');
                setChartTheme(false);
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('color-theme', 'dark');
                setChartTheme(true);
            }
        });

        // --- Chart Logic ---
        const reportData = {{ data|safe }};
        const reportType = "{{ report_type }}";
        const chartType = "{{ chart_type }}";
        
        const ctx = document.getElementById('reportChart').getContext('2d');
        let chartConfig = {};

        function generateColors(count) {
            const colors = [
                'rgba(13, 148, 136, 0.7)',  // Teal
                'rgba(59, 130, 246, 0.7)',  // Blue
                'rgba(139, 92, 246, 0.7)',  // Purple
                'rgba(249, 115, 22, 0.7)',  // Orange
                'rgba(236, 72, 153, 0.7)',  // Pink
                'rgba(16, 185, 129, 0.7)',  // Emerald
                'rgba(99, 102, 241, 0.7)'   // Indigo
            ];
            return Array(count).fill().map((_, i) => colors[i % colors.length]);
        }

        if (reportType === 'daily_sales') {
            const labels = reportData.map(d => d.day);
            const values = reportData.map(d => d.total);
            
            chartConfig = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Sales',
                        data: values,
                        borderColor: '#0d9488', // Teal-600
                        backgroundColor: 'rgba(13, 148, 136, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { 
                        y: { beginAtZero: true } 
                    } 
                }
            };
        } else if (reportType === 'monthly_sales') {
            const labels = reportData.map(d => d.period);
            const values = reportData.map(d => d.total);
            
            chartConfig = {
                type: 'bar', /* Monthly looks better as bar usually, but line is requested? Let's stick to bar for monthly to differentiate? Or line. User said "options... for monthly sale". Let's use Line for consistency or Bar. Let's use Line for now as per previous trend style. actually let's use Bar for monthly to distinguish. */
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Sales',
                        data: values,
                        backgroundColor: '#3b82f6', // Blue
                        borderRadius: 4,
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { 
                        y: { beginAtZero: true } 
                    } 
                }
            };
        } else {
            let labels = [];
            let values = [];
            let labelText = "Count";

            if (Array.isArray(reportData) && reportData.length > 0) {
                 if (reportType === 'top_customers') {
                     labels = reportData.map(d => d.email);
                     values = reportData.map(d => d.total_spent);
                     labelText = "Total Spent";
                 } else if (reportType === 'top_products' || reportType === 'top_categories') {
                     labels = reportData.map(d => d.name);
                     values = reportData.map(d => d.count);
                     labelText = "Units Sold";
                 } else if (reportType === 'branch_sales') {
                     labels = reportData.map(d => d.branch__name);
                     values = reportData.map(d => d.count);
                     labelText = "Orders";
                 } else if (reportType === 'order_status') {
                     labels = reportData.map(d => d.status);
                     values = reportData.map(d => d.count);
                     labelText = "Orders";
                 }
            }
            
            chartConfig = {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelText,
                        data: values,
                        backgroundColor: generateColors(values.length),
                        borderColor: 'transparent',
                        borderWidth: 1
                    }]
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: (reportType === 'top_products') ? 'y' : 'x', 
                }
            };
        }

        new Chart(ctx, chartConfig);

        function applyFilter() {
            const branchId = document.getElementById('branchFilter').value;
            const url = new URL(window.location.href);
            url.searchParams.set('branch', branchId);
            window.location.href = url.toString();
        }

        function downloadChart() {
            const link = document.createElement('a');
            link.download = `report_${reportType}.png`;
            link.href = document.getElementById('reportChart').toDataURL('image/png', 1.0);
            link.click();
        }
    </script>
</body>
</html>
