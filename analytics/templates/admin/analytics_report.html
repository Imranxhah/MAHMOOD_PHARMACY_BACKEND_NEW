{% load static %}
<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }} - Mahmood Pharmacy Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        teal: {
                            50: '#f0fdfa',
                            100: '#ccfbf1',
                            500: '#14b8a6',
                            600: '#0d9488',
                            700: '#0f766e',
                            800: '#115e59',
                            900: '#134e4a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .dark body {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .dark .glass-effect {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .dark .gradient-text {
            background: linear-gradient(135deg, #14b8a6 0%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out forwards;
        }
        
        .animate-slide-in {
            animation: slideIn 0.5s ease-out forwards;
        }
        
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-gradient:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .dark .btn-gradient {
            background: linear-gradient(135deg, #14b8a6 0%, #06b6d4 100%);
        }
        
        .dark .btn-gradient:hover {
            background: linear-gradient(135deg, #06b6d4 0%, #14b8a6 100%);
            box-shadow: 0 10px 25px rgba(20, 184, 166, 0.4);
        }
        
        .chart-container {
            position: relative;
            overflow: hidden;
        }
        
        .chart-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            animation: shimmer 3s linear infinite;
        }
        
        .dark .chart-container::before {
            background: linear-gradient(90deg, #14b8a6, #06b6d4, #14b8a6);
            background-size: 200% 100%;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .filter-dropdown {
            transition: all 0.3s ease;
        }
        
        .filter-dropdown:focus {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3);
        }
        
        .floating-icon {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .nav-link {
            position: relative;
            transition: color 0.3s ease;
        }
        
        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }
        
        .nav-link:hover::after {
            width: 100%;
        }
        
        .dark .nav-link::after {
            background: linear-gradient(90deg, #14b8a6, #06b6d4);
        }
    </style>
    <script>
        if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="min-h-screen transition-all duration-500">

    <!-- Navbar with Glass Effect -->
    <nav class="sticky top-0 z-50 glass-effect shadow-2xl">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                <div class="flex items-center gap-4 animate-slide-in">
                    <div class="floating-icon">
                        <img src="{% static 'img/app_logo.png' %}" alt="Logo" class="h-12 w-auto">
                    </div>
                    <div>
                        <a href="{% url 'admin-charts' %}" class="text-2xl font-extrabold gradient-text">
                            Mahmood Pharmacy
                        </a>
                        <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">Advanced Analytics Platform</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-6">
                    <a href="{% url 'admin-charts' %}" class="nav-link text-sm font-semibold text-slate-700 hover:text-purple-600 transition-colors dark:text-slate-300 dark:hover:text-teal-400">
                        <i class="fa-solid fa-arrow-left mr-2"></i> Dashboard
                    </a>
                    
                    <button id="theme-toggle" class="p-3 rounded-xl glass-effect hover:scale-110 transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-purple-300 dark:focus:ring-teal-500" title="Toggle Dark Mode">
                        <i id="theme-toggle-dark-icon" class="hidden fa-solid fa-moon text-xl text-purple-600"></i>
                        <i id="theme-toggle-light-icon" class="hidden fa-solid fa-sun text-xl text-amber-500"></i>
                    </button>
                    
                    <div class="hidden sm:flex items-center gap-4 border-l-2 border-purple-200 pl-6 dark:border-slate-600">
                        <div class="text-right">
                            <p class="text-sm font-bold text-slate-900 dark:text-white">Admin User</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400">
                                <i class="fa-solid fa-circle text-green-500 text-xs mr-1"></i> Online
                            </p>
                        </div>
                        <div class="h-12 w-12 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold text-lg shadow-lg">A</div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        
        <!-- Header Section -->
        <div class="glass-effect rounded-3xl shadow-2xl p-8 mb-8 animate-fade-in-up">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                <div class="flex-1">
                    <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3 mb-3">
                        <div class="h-12 w-12 rounded-2xl bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center shadow-lg flex-shrink-0">
                            <i class="fa-solid fa-chart-line text-white text-xl"></i>
                        </div>
                        <div>
                            <h1 class="text-2xl sm:text-3xl md:text-4xl font-extrabold gradient-text">{{ title }}</h1>
                            <p class="text-xs sm:text-sm text-slate-600 dark:text-slate-400 font-medium mt-1">
                                <i class="fa-solid fa-calendar-days mr-2"></i>Real-time performance insights
                            </p>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-4 w-full sm:w-auto">
                    <div class="glass-effect p-3 sm:p-4 rounded-2xl shadow-lg w-full sm:w-auto">
                        <label for="branchFilter" class="block text-xs font-bold text-slate-600 dark:text-slate-300 mb-2 uppercase tracking-wider">
                            <i class="fa-solid fa-filter mr-2"></i> Filter Branch
                        </label>
                        <select id="branchFilter" onchange="applyFilter()" class="filter-dropdown bg-white dark:bg-slate-700 border-2 border-purple-200 dark:border-slate-600 text-slate-900 dark:text-white text-sm rounded-xl focus:ring-purple-500 focus:border-purple-500 block w-full p-2 sm:p-3 font-medium cursor-pointer">
                            <option value="all" {% if selected_branch == 'all' %}selected{% endif %}>üåê All Branches</option>
                            {% for branch in branches %}
                                <option value="{{ branch.id }}" {% if selected_branch == branch.id %}selected{% endif %}>üìç {{ branch.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Container with Modern Design -->
        <div class="glass-effect rounded-3xl shadow-2xl overflow-hidden animate-fade-in-up" style="animation-delay: 0.2s;">
            <div class="chart-container">
                <div class="p-4 sm:p-6 md:p-8">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6 gap-4">
                        <div>
                            <h2 class="text-xl sm:text-2xl font-bold text-slate-900 dark:text-white mb-1">Data Visualization</h2>
                            <p class="text-xs sm:text-sm text-slate-500 dark:text-slate-400">Interactive chart analysis</p>
                        </div>
                        <button onclick="downloadChart()" class="btn-gradient text-white px-4 sm:px-6 py-2 sm:py-3 rounded-xl text-sm font-bold shadow-xl flex items-center gap-2 sm:gap-3 w-full sm:w-auto justify-center">
                            <i class="fa-solid fa-download"></i> Download PNG
                        </button>
                    </div>
                    
                    <div class="relative w-full bg-gradient-to-br from-slate-50 to-slate-100 dark:from-slate-800 dark:to-slate-900 rounded-2xl p-4 md:p-6" style="{% if chart_type == 'pie' or chart_type == 'doughnut' %}height: 400px;{% else %}height: 400px;{% endif %}">
                        <canvas id="reportChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script>
        // Dark Mode Logic
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

        function setChartTheme(isDark) {
            const color = isDark ? '#cbd5e1' : '#475569';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(0, 0, 0, 0.08)';
            
            Chart.defaults.color = color;
            Chart.defaults.scale.grid.color = gridColor;
            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.font.size = 13;
            
            const chartInstance = Chart.getChart("reportChart");
            if (chartInstance) {
                chartInstance.update();
            }
        }

        if (document.documentElement.classList.contains('dark')) {
            themeToggleLightIcon.classList.remove('hidden');
            setChartTheme(true);
        } else {
            themeToggleDarkIcon.classList.remove('hidden');
            setChartTheme(false);
        }

        themeToggleBtn.addEventListener('click', function() {
            themeToggleDarkIcon.classList.toggle('hidden');
            themeToggleLightIcon.classList.toggle('hidden');

            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('color-theme', 'light');
                setChartTheme(false);
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('color-theme', 'dark');
                setChartTheme(true);
            }
        });

        // Chart Logic with Enhanced Styling
        const reportData = {{ data|safe }};
        const reportType = "{{ report_type }}";
        const chartType = "{{ chart_type }}";
        
        const ctx = document.getElementById('reportChart').getContext('2d');
        let chartConfig = {};

        function generateGradient(ctx, color1, color2) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, color1);
            gradient.addColorStop(1, color2);
            return gradient;
        }

        function generateColors(count) {
            const colors = [
                ['#667eea', '#764ba2'],  // Purple
                ['#f093fb', '#f5576c'],  // Pink
                ['#4facfe', '#00f2fe'],  // Blue
                ['#43e97b', '#38f9d7'],  // Green
                ['#fa709a', '#fee140'],  // Orange
                ['#30cfd0', '#330867'],  // Teal
                ['#ff6b6b', '#ee5a6f'],  // Red
                ['#ffd93d', '#f6a623'],  // Yellow
                ['#a8edea', '#fed6e3'],  // Pastel
                ['#ff9a9e', '#fecfef']   // Rose
            ];
            return colors.slice(0, count).map(([c1, c2]) => {
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, c1);
                gradient.addColorStop(1, c2);
                return gradient;
            });
        }
        
        function calculatePercentages(data) {
            const total = data.reduce((sum, item) => sum + item, 0);
            return data.map(value => ((value / total) * 100).toFixed(1));
        }

        if (reportType === 'daily_sales') {
            const labels = reportData.map(d => d.day);
            const values = reportData.map(d => d.total);
            
            const gradient = generateGradient(ctx, 'rgba(102, 126, 234, 0.8)', 'rgba(118, 75, 162, 0.1)');
            
            chartConfig = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Sales Revenue',
                        data: values,
                        borderColor: '#667eea',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#667eea',
                        pointBorderWidth: 3,
                        pointHoverBackgroundColor: '#667eea',
                        pointHoverBorderColor: '#fff',
                        borderWidth: 3
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                font: { size: 14, weight: 'bold' },
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            borderColor: '#667eea',
                            borderWidth: 2
                        }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            grid: { drawBorder: false },
                            ticks: { padding: 10 }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { padding: 10 }
                        }
                    } 
                }
            };
        } else if (reportType === 'monthly_sales') {
            const labels = reportData.map(d => d.period);
            const values = reportData.map(d => d.total);
            
            chartConfig = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Sales Revenue',
                        data: values,
                        backgroundColor: generateColors(values.length),
                        borderRadius: 12,
                        borderSkipped: false
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                font: { size: 14, weight: 'bold' },
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 },
                            borderColor: '#667eea',
                            borderWidth: 2
                        }
                    },
                    scales: { 
                        y: { 
                            beginAtZero: true,
                            grid: { drawBorder: false },
                            ticks: { padding: 10 }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { padding: 10 }
                        }
                    } 
                }
            };
        } else {
            let labels = [];
            let values = [];
            let labelText = "Count";

            if (Array.isArray(reportData) && reportData.length > 0) {
                 if (reportType === 'top_customers') {
                     labels = reportData.map(d => d.email);
                     values = reportData.map(d => d.total_spent);
                     labelText = "Total Spent";
                 } else if (reportType === 'top_products' || reportType === 'top_categories') {
                     // Filter out null or empty names
                     const filteredData = reportData.filter(d => d.name && d.name !== 'null');
                     labels = filteredData.map(d => d.name);
                     values = filteredData.map(d => d.count);
                     labelText = "Units Sold";
                 } else if (reportType === 'branch_sales') {
                     labels = reportData.map(d => d.branch__name);
                     values = reportData.map(d => d.count);
                     labelText = "Orders";
                 } else if (reportType === 'order_status') {
                     labels = reportData.map(d => d.status);
                     values = reportData.map(d => d.count);
                     labelText = "Orders";
                 }
            }
            
            const percentages = calculatePercentages(values);
            
            chartConfig = {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelText,
                        data: values,
                        backgroundColor: generateColors(values.length),
                        borderColor: '#fff',
                        borderWidth: chartType === 'pie' || chartType === 'doughnut' ? 3 : 0,
                        borderRadius: chartType === 'bar' ? 12 : 0
                    }]
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: (reportType === 'top_products') ? 'y' : 'x',
                    plugins: {
                        legend: {
                            display: chartType === 'pie' || chartType === 'doughnut',
                            // Position bottom for top_categories as requested, or generally for all circular charts for better visibility
                            position: 'bottom',
                            labels: {
                                font: { size: window.innerWidth < 768 ? 11 : 13, weight: 'bold' },
                                padding: window.innerWidth < 768 ? 10 : 20,
                                usePointStyle: true,
                                // Sky blue color for visibility in both modes (sky-500)
                                color: '#0ea5e9', 
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = percentages[i];
                                            return {
                                                text: `${label}: ${value} (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                fontColor: '#0ea5e9', // Explicitly set text color for the item
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.9)',
                            padding: 16,
                            titleFont: { size: 15, weight: 'bold' },
                            bodyFont: { size: 14 },
                            borderColor: '#667eea',
                            borderWidth: 2,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || context.parsed === 0 ? context.parsed : '';
                                    const percentage = percentages[context.dataIndex];
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        },
                        datalabels: chartType === 'pie' || chartType === 'doughnut' ? {
                            color: '#fff',
                            font: {
                                size: 14,
                                weight: 'bold'
                            },
                            formatter: (value, context) => {
                                return percentages[context.dataIndex] + '%';
                            }
                        } : false
                    },
                    scales: chartType !== 'pie' && chartType !== 'doughnut' ? {
                        y: { 
                            beginAtZero: true,
                            grid: { drawBorder: false },
                            ticks: { padding: 10 }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { padding: 10 }
                        }
                    } : {}
                }
            };
        }

        new Chart(ctx, chartConfig);

        function applyFilter() {
            const branchId = document.getElementById('branchFilter').value;
            const url = new URL(window.location.href);
            url.searchParams.set('branch', branchId);
            window.location.href = url.toString();
        }

        function downloadChart() {
            const link = document.createElement('a');
            link.download = `report_${reportType}.png`;
            link.href = document.getElementById('reportChart').toDataURL('image/png', 1.0);
            link.click();
        }
    </script>
</body>
</html>